directly. Publishers of SPF FAIL policies must accept this potential problem. They should test (e.g., with a SOFTFAIL policy) until they are satisfied with the results. See below for a list of alternatives to plain message forwarding. ===HELO tests=== For an empty Return-Path as used in [[Bounce message|error messages]] and other auto-replies, an SPF check of the HELO-identity is mandatory. With a bogus HELO identity the result NONE would not help, but for valid host names SPF also protects the HELO identity. This SPF feature was always supported as an option for receivers, and later SPF drafts including the final specification recommend to check the HELO always. This allows to white list sending mailers based on a HELO PASS, or to reject all mails after a HELO FAIL. It can also be used in [[reputation system]]s (any white or black list is a simple case of a reputation system). ==Implementation== Compliance with SPF consists of three loosely related tasks: ; Publish a policy : Domains identify the machines authorized to send e-mail on their behalf. Domains do this by adding additional records to their existing DNS information: every [[domain name]] that has an [[A record]] or [[MX record]] deserves an SPF record specifying the policy if it is used either in an email address or as HELO/EHLO argument. ; Check and use SPF information : Receivers use ordinary DNS queries, which are typically cached to enhance performance. Receivers then interpret the SPF information as specified and act upon the result. ; Revise mail forwarding : Plain mail forwarding is not allowed by SPF. The alternatives are :* remailing, i.e. replacing the original sender with one belonging to the local domain, :* refusing, i.e. answering <code>551 User not local; please try <user@example.com></code>, :* [[whitelisting]] on the target server, so that it will not refuse a forwarded message, and :* [[Sender Rewriting Scheme]], a more complicated mechanism that handles routing non-delivery notifications to the original sender. Thus, the key issue in SPF is the specification for the new DNS information that domains set and receivers use. The records are laid out like this (in typical DNS-syntax): example.com. IN SPF "v=spf1 a mx -all" "v=" defines the version of SPF used. The following words provide ''mechanisms'' to use to determine if a domain is eligible to send mail. The "a" and "mx" specify the systems permitted to send messages for the given domain. The "-all" at the end specifies that, if the previous ''mechanisms'' did not match, the message should be rejected. ===Mechanisms=== Eight ''mechanisms'' are defined: {| | valign="top" | ALL || Matches always; used for a default result like <tt>-all</tt> for all IPs not matched by prior mechanisms. |- | valign="top" | A || If the domain name has an address record (A or AAAA) that can be resolved to the sender's address, it will match. |- | valign="top" | IP4 || If the sender is in a given [[IPv4]] address range, match. |- | valign="top" | IP6 || If the sender is in a given [[IPv6]] address range, match. |- | valign="top" | MX || If the domain name has an [[MX record]] resolving to the sender's address, it will match (i.e. the mail comes from one of the domain's mail servers). |- | valign="top" | PTR || If the domain name ([[PTR record]]) for the client's address is in the given domain and that domain name resolves to the client's address ([[forward-confirmed reverse DNS]]), match. |- | valign="top" | EXISTS || If the given domain name resolves to any address, match (no matter the address it resolves to). This is rarely used. Along with the SPF macro language it offers more complex matches like [[DNSBL]]-queries. |- | valign="top" | INCLUDE || If the ''included'' (a misnomer) policy passes the test this mechanism matches. This is typically used to ''include'' policies of more than one [[Internet service provider|ISP]]. |} ===Qualifiers=== Each ''mechanism'' can be combined with one of four ''qualifiers'': * '''<tt>+</tt>''' for a PASS result. This can be omitted; e.g., <tt>+mx</tt> is the same as <tt>mx</tt>. * '''<tt>?</tt>''' for a NEUTRAL result interpreted like NONE (no policy). * '''<tt>~</tt>''' for SOFTFAIL, a debugging aid between NEUTRAL and FAIL. Typically, messages that return a SOFTFAIL are accepted but tagged. * '''<tt>-</tt>''' for FAIL, the mail should be rejected (see below). ===Modifiers=== The ''modifiers'' allow for future extensions to the framework. To date only the two ''modifiers'' defined in the RFC 4408 have been widely deployed: *<tt>exp=some.example.com</tt> gives the name of a domain with a [[Domain Name System|DNS]] TXT record (interpreted using SPF's macro language) to get an explanation for FAIL resultsâ€”typically a [[Uniform Resource Locator|URL]] which is added to the SMTP error code. This feature is rarely used. *<tt>redirect=some.example.com</tt> can be used instead of the ALL-''mechanism'' to link to the policy record of another domain. This ''modifier'' is easier to understand than the somewhat similar INCLUDE-''mechanism''. ===Error handling=== As soon as SPF implementations detect syntax errors in a sender policy they '''must''' abort the evaluation with result PERMERROR. Skipping erroneous ''mechanisms'' cannot work as expected, therefore <tt>include:bad.example</tt> and <tt>redirect=bad.example</tt> also cause a PERMERROR. Another safety guard is the maximum of ten mechanisms querying DNS, i.e. any mechanism except from IP4, IP6, and ALL. Implementations can abort the evaluation with result SOFTERROR when it takes too long or a DNS query times out, but they '''must''' return PERMERROR if the policy directly or indirectly needs more than ten queries for ''mechanisms''. Any <tt>redirect=</tt> also counts towards this ''processing limit''. A typical SPF HELO policy <tt>v=spf1 a -all</tt> may execute up to three DNS queries: (1) SPF, (2) TXT (deprecated, but for backwards compatibility during the transition), and (3) A or AAAA. This last query counts as the first ''mechanism'' towards the limit (10). In this example it is also the last, because ALL needs no DNS lookup. ==Caveats== ===Interpretation=== SPF FAIL policies can be an effective but problematic tool. A typical example is a user that wishes to send an email 