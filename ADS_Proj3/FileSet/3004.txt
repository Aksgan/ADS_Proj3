will experience due to scattering, both from the patient tissue as well as scattering from collimation upstream in the linear accelerator. ===Photodynamic therapy=== In [[Photodynamic therapy]] (PDT) light is used to activate chemotherapy agents. Due to the nature of PDT, it is useful to use Monte Carlo methods for modeling scattering and absorption in the tissue in order to ensure appropriate levels of light are delivered to activate chemotherapy agents. ==Implementation of photon transport in a scattering medium== Presented here is a model of a photon Monte Carlo method in a homogeneous infinite medium, however the model is easily extended for multi-layered media. For an inhomogeneous medium, boundaries must be considered. In addition for a semi-infinite medium (in which photons are considered lost if they exit the top boundary), special consideration must be taken. For more information, please visit the links at the bottom of the page. We will solve the problem using an infinitely small point source (represented analytically as a [[Dirac delta function]] in space and time). Responses to arbitrary source geometries can be constructed using the method of [[Green's functions]] (or [[convolution]], if enough spatial symmetry exists). The required parameters are the [[absorption coefficient]], the scattering coefficient, and the scattering phase function. (If boundaries are considered the index of refraction for each medium must also be provided.) Time-resolved responses are found by keeping track of the total elapsed time of the photon's flight using the [[optical path length]]. Responses to sources with arbitrary time profiles can then be modeled through convolution in time. In our simplified model we use the following variance reduction technique to reduce computational time. Instead of propagating photons individually, we create a photon packet with a specific weight (generally initialized as unity). As the photon interacts in the turbid medium, it will deposit weight due to absorption and the remaining weight will be scattered to other parts of the medium. Any number of variables can be logged along the way, depending on the interest of a particular application. Each photon packet will repeatedly undergo the following numbered steps until it is either terminated, reflected, or transmitted. The process is diagrammed in the schematic to the right. Any number of photon packets can be launched and modeled, until the resulting simulated measurements have the desired signal-to-noise ratio. Note that as Monte Carlo modeling is a statistical process involving random numbers, we will be using the variable ξ throughout as a [[Pseudorandom number generator|pseudo-random number]] for many calculations.[[Image:MonteCarlo.png|thumb|right|Schematic for modeling photon flow in an in infinite scattering and absorbing medium with Monte Carlo simulations.]] ===Step 1: Launching a photon packet=== In our model, we are ignoring initial specular reflectance associated with entering a medium that is not refractive index matched. With this in mind, we simply need to set the initial position of the photon packet as well as the initial direction. It is convenient to use a global coordinate system. We will use three [[Cartesian coordinate system|Cartesian coordinates]] to determine position, along with three [[Unit vector|direction cosines]] to determine the direction of propagation. The initial start conditions will vary based on application, however for a pencil beam initialized at the origin, we can set the initial position and direction cosines as follows (isotropic sources can easily be modeled by randomizing the initial direction of each packet): : <math> \begin{align} x & = 0 \\ \text{Position: }y & = 0 \\ z & = 0 \\ \\ \mu_x & = 0 \\ \text{Direction cosines: } \mu_y & = 0 \\ \mu_z & = 1 \end{align} </math> ===Step 2: Step size selection and photon packet movement=== The step size, ''s'', is the distance the photon packet travels between interaction sites. There are a variety of methods for step size selection. Below is a basic form of photon step size selection (derived using the [[Inverse transform sampling|inverse distribution method]] and the [[Beer&ndash;Lambert law]]) from which we use for our homogeneous model: : <math>s = -\frac{\ln\xi}{\mu_t}</math> Once a step size is selected, the photon packet is propagated by a distance ''s'' in a direction defined by the direction cosines. This is easily accomplished by simply updating the coordinates as follows: : <math> \begin{align} x & \leftarrow x + \mu_x s \\ y & \leftarrow y + \mu_y s \\ z & \leftarrow z + \mu_z s \end{align} </math> ===Step 3: Absorption and scattering=== A portion of the photon weight is absorbed at each interaction site. This fraction of the weight is determined as follows: : <math>\Delta W = \frac{\mu_a}{\mu_t} W</math> The weight fraction can then be recorded in an array if an absorption distribution is of interest for the particular study. The weight of the photon packet must then be updated as follows: : <math>W \leftarrow W - \Delta W \, </math> Following absorption, the photon packet is scattered. The weighted average of the cosine of the photon scattering angle is known as scattering anisotropy (''g''), which has a value between &minus;1 and 1. If the optical anisotropy is 0, this generally indicates that the scattering is isotropic. If ''g'' approaches a value of 1 this indicates that the scattering is primarily in the forward direction. In order to determine the new direction of the photon packet (and hence the photon direction cosines), we need to know the scattering phase function. Often the Henyey-Greenstein phase function is used. Then the scattering angle, θ, is determined using the following formula. : <math>\cos\theta = \begin{cases} \frac{1}{2g} \left[ 1 + g^2 - \left(\frac{1-g^2}{1-g+2g\xi}\right)^2\right]&\text{ if }g\ne 0 \\ 1-2\xi&\text{ if }g= 0 \end{cases} </math> And, the polar angle ''&phi;'' is generally assumed to be uniformly distributed between 0 and <math> 2\pi </math>. Based on this assumption, we can set: : <math> \varphi = 2\pi\xi\frac{}{} </math> Based on these angles and the original direction cosines, we can find a new set of direction cosines. The new propagation direction can be represented in the global coordinate system as follows: : <math> \begin{align} \mu'_x & = \frac{\sin\theta(\mu_x \mu_z \cos\varphi - \mu_y \sin\varphi)}{\sqrt{1-\mu_z^2}}+ \mu_x \cos\theta \\ 