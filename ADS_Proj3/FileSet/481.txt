the IPv4 (default), IPv6, IPv4/IPv6 Virtual Private Networks and multicast BGP. Increasingly, BGP is used as a generalized signaling protocol to carry information about routes that may not be part of the global Internet, such as VPNs.<ref>[http://www.ietf.org/rfc/rfc2547.txt BGP/MPLS VPNs.], RFC 2547, E. Rosen and Y. Rekhter,April 2004</ref> ===Finite State Machine=== [[Image:BGP FSM.svg|right|thumb|549px|BGP state machine]] In order to make decisions in its operations with other BGP peers, a BGP peer uses a simple [[finite state machine]] (FSM) that consists of six states: Idle; Connect; Active; OpenSent; OpenConfirm; and Established. For each peer-to-peer session, a BGP implementation maintains a state variable that tracks which of these six states the session is in. The BGP protocol defines the messages that each peer should exchange in order to change the session from one state to another. The first state is the “Idle” state. In the “Idle” state, BGP initializes all resources, refuses all inbound BGP connection attempts and initiates a TCP connection to the peer. The second state is “Connect”. In the “Connect” state, the router waits for the TCP connection to complete and transitions to the "OpenSent" state if successful. If unsuccessful, it resets the ConnectRetry timer and transitions to the "Active" state upon expiration. In the "Active" state, the router resets the ConnectRetry timer to zero and returns to the "Connect" state. In the "OpenSent" state, the router sends an Open message and waits for one in return. Keepalive messages are exchanged and, upon successful receipt, the router is placed into the “Established” state. In the “Established” state, the router can send/receive: Keepalive; Update; and Notification messages to/from its peer. *'''Idle State''': ** Refuse all incoming BGP connections ** Start event triggers the initialization of resources for the BGP process. ** Initiates a TCP connection with its configured BGP peer. ** Listens for a TCP connection from its peer. ** Changes its state to Connect. ** If an error occurs at any state of the FSM process, the BGP session is terminated immediately and returned to the Idle state. Some of the reasons why a router does not progress from the Idle state are: *** TCP port 179 is not open. *** A random TCP port over 1023 is not open. *** Peer address configured incorrectly on either router. *** AS number configured incorrectly on either router . *'''Connect State''': **Waits for successful TCP negotiation with peer. **BGP does not spend much time in this state if the TCP session has been successfully established. **Sends Open message to peer and changes state to OpenSent. **If an error occurs, BGP moves to the Active state. Some reasons for the error are: *** TCP port 179 is not open. *** A random TCP port over 1023 is not open. *** Peer address configured incorrectly on either router. *** AS number configured incorrectly on either router. * '''Active State''': ** If the router was unable to establish a successful TCP session, then it ends up in the Active state. ** BGP FSM will try to restart another TCP session with the peer and, if successful, then it will send an Open message to the peer. ** If it is unsuccessful again, the FSM is reset to the Idle state. ** Repeated failures may result in a router cycling between the Idle and Active states. Some of the reasons for this include: *** TCP port 179 is not open. *** A random TCP port over 1023 is not open. *** BGP configuration error. *** Network congestion. *** Flapping network interface. * '''OpenSent State''': ** BGP FSM listens for an Open message from its peer. ** Once the message has been received, the router checks the validity of the Open message. ** If there is an error it is because one of the fields in the Open message doesn’t match between the peers, e.g. BGP version mismatch, MD5 password mismatch, the peering router expects a different My AS. The router will then send a Notification message to the peer indicating why the error occurred. ** If there is no error, a Keepalive message is sent, various timers are set and the state is changed to OpenConfirm. * '''OpenConfirm State''': ** The peer is listening for a Keepalive message from its peer. ** If a Keepalive message is received and no timer has expired before reception of the Keepalive, BGP transitions to the Established state. ** If a timer expires before a Keepalive message is received, or if an error condition occurs, the router transitions back to the Idle state. * '''Established State''': ** In this state, the peers send Update messages to exchange information about each route being advertised to the BGP peer. ** If there is any error in the Update message then a Notification message is sent to the peer, and BGP transitions back to the Idle state. ** If a timer expires before a Keepalive message is received, or if an error condition occurs, the router transitions back to the Idle state. ===Basic BGP updates=== Once a BGP session is running, the BGP speakers exchange UPDATE messages about destinations to which the speaker offers connectivity. In the protocol, the basic [[Classless Inter-Domain Routing|CIDR]] route description is called Network Layer Reachability Information (NLRI). NLRI includes the expected destination prefix, prefix length, path of autonomous systems to the destination and next hop in '''attributes''', which can carry a wide range of additional information that affects the acceptance policy of the receiving router. BGP speakers incrementally announce new NLRI to which they offer reachability, but also announce ''withdrawals'' of prefixes to which the speaker no longer offers connectivity. ==BGP router connectivity and learning routes== In the simplest arrangement all routers within a single AS and participating in BGP routing must be configured in a full mesh: each router must be configured as peer to every other router. This causes scaling problems, since the number of required connections [[quadratic growth|grows quadratically]] with the number of routers involved. To alleviate the problem, BGP implements two options: route reflectors (RFC 